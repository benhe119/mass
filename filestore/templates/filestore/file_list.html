{% extends 'base.html' %}

{% load static %}

{% block content %}
{{ form.errors }}
  <div class="content">
    <h1>Files</h1>
    <p><a href="{% url 'file-create' %}">Add File</a></p>
    {% if files %}
    <button class="button is-link is-danger" id="show_delete_modal_btn" disabled>Delete</button>
    <form action="{% url 'file-list' %}" method="post">
    <div class="modal" id="confirm_delete_modal">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Modal title</p>
        </header>
        <section class="modal-card-body">
          <!-- Content ... -->
        </section>
        <footer class="modal-card-foot">
          <button class="button is-danger">Confirm Delete</button>
          <a class="button" id="cancel_delete_btn">Cancel</a>
        </footer>
      </div>
    </div>
    {% csrf_token %}
    <table class="table is-striped is-hoverable">
      <thead>
        <tr>
          <th><input type="checkbox" id="select_all"></th>
          <th>Filename</th>
          <th>Size</th>
          <th>SHA256</th>
          <th>Added</th>
          <th>Proc. Time</th>
        </tr>
      </thead>
      <tbody>
        {% for file in files %}
          <tr>
            <td><input type="checkbox" class="selected_files" value="{{ file.id }}" name="selected_files"></td>
            <td>
              <div class="tooltip"><a href="{% url 'file-detail' file.sha256 %}">{{ file.file_name }}</a>
                <span class="tooltiptext">{{ file.file_type|truncatechars:50 }}</span>
              </div>
            </td>
            <td>{{ file.size|filesizeformat }}</td>
            <td>
              <div class="tooltip">{{ file.sha256|truncatechars:15 }}
                <span class="tooltiptext">{{ file.sha256 }}</span>
              </div>
            </td>
            <td>{{ file.added|date:"Y-m-d H:i:s" }}</td>
            <td>{{ file.time_to_process }} ms</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
      <p>No Files</p>
    {% endif %}
  </div>
  </form>
<script>
'use strict';

document.addEventListener('DOMContentLoaded', function () {
  var rootEl = document.documentElement;
  var num_files = parseInt('{{ files|length }}');

  var show_delete_modal_btn = document.getElementById('show_delete_modal_btn');
  if (show_delete_modal_btn) {
    show_delete_modal_btn.addEventListener('click', function() {
      var confirm_delete_modal = document.getElementById('confirm_delete_modal');
      rootEl.classList.add('is-clipped');
      confirm_delete_modal.classList.add('is-active');
    });
  }

  var cancel_delete_btn = document.getElementById('cancel_delete_btn');
  if (cancel_delete_btn) {
    cancel_delete_btn.addEventListener('click', function() {
      var confirm_delete_modal = document.getElementById('confirm_delete_modal');
      rootEl.classList.remove('is-clipped');
      confirm_delete_modal.classList.remove('is-active');
    });
  }

  var select_all = document.getElementById('select_all');
  if (select_all) {
    select_all.addEventListener('click', function() {
      if (select_all.checked) {
        for (const selected_file of selected_files) {
          selected_file.checked = true;
        }
      } else {
        for (const selected_file of selected_files) {
          selected_file.checked = false;
        }
      }
      update_form();
    });
  }

  function update_form() {
    if (num_files > 0) {
      var checkedOne = select_all.checked || Array.prototype.slice.call(selected_files).some(x => x.checked);
      if (checkedOne) {
        show_delete_modal_btn.removeAttribute('disabled');
      } else {
        show_delete_modal_btn.setAttribute('disabled', '');
      }
    }
  }

  var selected_files = document.querySelectorAll('.selected_files');
  for (const selected_file of selected_files) {
    selected_file.addEventListener('click', function() {
      update_form();
    });
  }
  update_form();
});
</script>
{% endblock %}
